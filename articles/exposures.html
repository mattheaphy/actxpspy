<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>actxps - Exposure calculations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">actxps</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../articles/actxps.html" rel="" target="">
 <span class="menu-text">Get started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-articles" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Articles</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-articles">    
        <li>
    <a class="dropdown-item" href="../articles/exposures.html" rel="" target="">
 <span class="dropdown-text">Exposure calculations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/exp_summary.html" rel="" target="">
 <span class="dropdown-text">Experience summaries</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/transactions.html" rel="" target="">
 <span class="dropdown-text">Transaction studies</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/visualizations.html" rel="" target="">
 <span class="dropdown-text">Data visualizations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/misc.html" rel="" target="">
 <span class="dropdown-text">Other functions</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../changelog.html" rel="" target="">
 <span class="menu-text">Changelog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mattheaphy/actxpspy" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-r-circle-fill" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-r-circle-fill" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-r-circle-fill">    
        <li class="dropdown-header">R version of actxps</li>
        <li>
    <a class="dropdown-item" href="https://github.com/mattheaphy/actxps" rel="" target="">
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mattheaphy.github.io/actxps" rel="" target="">
 <span class="dropdown-text">Package documentation</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#toy-census-data" id="toc-toy-census-data" class="nav-link active" data-scroll-target="#toy-census-data">Toy census data</a></li>
  <li><a href="#policy-year-exposures" id="toc-policy-year-exposures" class="nav-link" data-scroll-target="#policy-year-exposures">Policy year exposures</a>
  <ul class="collapse">
  <li><a href="#study-start-date" id="toc-study-start-date" class="nav-link" data-scroll-target="#study-start-date">Study start date</a></li>
  <li><a href="#target-status" id="toc-target-status" class="nav-link" data-scroll-target="#target-status">Target status</a></li>
  </ul></li>
  <li><a href="#other-exposure-periods" id="toc-other-exposure-periods" class="nav-link" data-scroll-target="#other-exposure-periods">Other exposure periods</a>
  <ul class="collapse">
  <li><a href="#calendar-years" id="toc-calendar-years" class="nav-link" data-scroll-target="#calendar-years">Calendar years</a></li>
  <li><a href="#quarters-months-and-weeks" id="toc-quarters-months-and-weeks" class="nav-link" data-scroll-target="#quarters-months-and-weeks">Quarters, months, and weeks</a></li>
  <li><a href="#convenience-functions" id="toc-convenience-functions" class="nav-link" data-scroll-target="#convenience-functions">Convenience functions</a></li>
  </ul></li>
  <li><a href="#split-exposures-by-calendar-period-and-policy-year" id="toc-split-exposures-by-calendar-period-and-policy-year" class="nav-link" data-scroll-target="#split-exposures-by-calendar-period-and-policy-year">Split exposures by calendar period and policy year</a></li>
  <li><a href="#miscellaneous" id="toc-miscellaneous" class="nav-link" data-scroll-target="#miscellaneous">Miscellaneous</a>
  <ul class="collapse">
  <li><a href="#column-names" id="toc-column-names" class="nav-link" data-scroll-target="#column-names">Column names</a></li>
  <li><a href="#treatment-of-additional-columns-in-the-census-data" id="toc-treatment-of-additional-columns-in-the-census-data" class="nav-link" data-scroll-target="#treatment-of-additional-columns-in-the-census-data">Treatment of additional columns in the census data</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exposure calculations</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><strong>Census-level data</strong> refers to a data set wherein there is one row per policy. <strong>Exposure-level data</strong> expands census-level data such that there is one record per policy per observation period. Observation periods could be any meaningful period of time such as a policy year, policy month, calendar year, calendar quarter, calendar month, etc.</p>
<p>A common step in experience studies is converting census-level data into exposure-level data. The <code>ExposedDF</code> class performs this task. Specifically, this class:</p>
<ul>
<li>Expands a census-level data frame to an exposure-level data frame</li>
<li>Calculates partial exposures for left-censored and right-censored records using exact day counts</li>
<li>For terminated policies, sets the policy status to an active state for all observation periods except the last. Similarly, the termination date is set to <code>NA</code> for all periods except the last.</li>
<li>Adds identifier columns for observation periods</li>
</ul>
<p>If you already have exposure-level data available, the class method <code>ExposedDF.from_DataFrame()</code> can be used to convert a data frame into an <code>ExposedDF</code> object.</p>
<section id="toy-census-data" class="level2">
<h2 class="anchored" data-anchor-id="toy-census-data">Toy census data</h2>
<p>To get started, we’re going to use a toy census data frame from the actxps package that contains 3 policies: one active, one that terminated due to death, and one that terminated due to surrender.</p>
<p><code>toy_census</code> contains the 4 columns necessary to compute exposures:</p>
<ul>
<li><code>pol_num</code>: a unique identifier for individual policies</li>
<li><code>status</code>: the policy status</li>
<li><code>issue_date</code>: issue date</li>
<li><code>term_date</code>: termination date, if any. Otherwise <code>NA</code></li>
</ul>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> actxps <span class="im">as</span> xp</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>toy_census <span class="op">=</span> xp.load_toy_census()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>toy_census</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="packages" class="cell-output cell-output-display" data-execution_count="2">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (3, 4)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>cat</th>
<th>date</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Death"</td>
<td>2011-05-27</td>
<td>2020-09-14</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Surrender"</td>
<td>2009-11-10</td>
<td>2022-02-25</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>toy_census</code> is a Polars data frame. Actxps functions accept both Polars and Pandas data frames. For speed and efficiency reasons, Polars is used internally for all data wrangling, so if a Pandas data frame is passed to an actxps function it will be converted to Polars. To convert a Polars data frame to Pandas the method <code>DataFrame.to_pandas()</code> is available.</p>
</div>
</div>
</section>
<section id="policy-year-exposures" class="level2">
<h2 class="anchored" data-anchor-id="policy-year-exposures">Policy year exposures</h2>
<p>Let’s assume we’re performing an experience study as of 2022-12-31 and we’re interested in policy year exposures. Here’s what we should expect for our 3 policies.</p>
<ul>
<li>Policy 1 was issued on January 1, 2010 and has not terminated. Therefore we expect 13 exposure years.</li>
<li>Policy 2 was issued on May 27, 2011 and was terminated in 2020 due to death. The death occurred after the 9th policy anniversary, therefore we expect 9 fully exposed years and a partial exposure in the 10th year.</li>
<li>Policy 3 was issued on November 10, 2009 and was terminated in 2022 due to surrender. The surrender occurred after the 12th policy anniversary, therefore we expect 12 fully exposed years and a partial exposure in the 13th year.</li>
</ul>
<p>To calculate exposures, we pass our data to <code>ExposedDF()</code> and we specify a study <code>end_date</code>.</p>
<div id="expose-1" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>exposed_data <span class="op">=</span> xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This creates a new <code>ExposedDF</code> object, which contains a <code>data</code> property and additional attributes related to the experience study.</p>
<p>Let’s examine what happened to each policy.</p>
<p><strong>Policy 1</strong>: As expected, there are 13 rows for this policy. New columns were added for the policy year (<code>pol_yr</code>), date ranges (<code>pol_date_yr</code>, <code>pol_date_yr_end</code>), and exposure. All exposures are 100% since this policy was active for all 13 years.</p>
<p>When the data is printed, additional attributes from the <code>ExposedDF</code> class are displayed.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>exposed_data.data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expose-pol-1" class="cell-output cell-output-display" data-execution_count="4">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (13, 8)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>u32</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>1</td>
<td>2010-01-01</td>
<td>2010-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>2</td>
<td>2011-01-01</td>
<td>2011-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>3</td>
<td>2012-01-01</td>
<td>2012-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>4</td>
<td>2013-01-01</td>
<td>2013-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>5</td>
<td>2014-01-01</td>
<td>2014-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>9</td>
<td>2018-01-01</td>
<td>2018-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>10</td>
<td>2019-01-01</td>
<td>2019-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>11</td>
<td>2020-01-01</td>
<td>2020-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>12</td>
<td>2021-01-01</td>
<td>2021-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>13</td>
<td>2022-01-01</td>
<td>2022-12-31</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>Policy 2</strong>: There are 10 rows for this policy. The first 9 periods show the policy in an active <code>status</code> and the termination date (<code>term_date</code>) is set to <code>NA</code>. The last period includes the final status of “Death” and the actual termination date. The last exposure is less than one because roughly a third of a year elapsed between the last anniversary date on 2020-05-27 and the termination date on 2020-09-14.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>exposed_data.data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expose-pol-2" class="cell-output cell-output-display" data-execution_count="5">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 8)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>u32</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>1</td>
<td>2011-05-27</td>
<td>2012-05-26</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2</td>
<td>2012-05-27</td>
<td>2013-05-26</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>3</td>
<td>2013-05-27</td>
<td>2014-05-26</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>4</td>
<td>2014-05-27</td>
<td>2015-05-26</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>5</td>
<td>2015-05-27</td>
<td>2016-05-26</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>6</td>
<td>2016-05-27</td>
<td>2017-05-26</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>7</td>
<td>2017-05-27</td>
<td>2018-05-26</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>8</td>
<td>2018-05-27</td>
<td>2019-05-26</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>9</td>
<td>2019-05-27</td>
<td>2020-05-26</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Death"</td>
<td>2011-05-27</td>
<td>2020-09-14</td>
<td>10</td>
<td>2020-05-27</td>
<td>2021-05-26</td>
<td>0.30411</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>Policy 3</strong>: There are 13 rows for this policy. The first 12 periods show the policy in an active <code>status</code> and the termination date (<code>term_date</code>) is set to <code>NA</code>. The last period includes the final status of “Surrender” and the actual termination date. The last exposure is less than one because the roughly a third of a year elapsed between the last anniversary date on 2021-11-10 and the termination date on 2022-02-25.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>exposed_data.data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expose-pol-3" class="cell-output cell-output-display" data-execution_count="6">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (13, 8)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>u32</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>1</td>
<td>2009-11-10</td>
<td>2010-11-09</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>2</td>
<td>2010-11-10</td>
<td>2011-11-09</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>3</td>
<td>2011-11-10</td>
<td>2012-11-09</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>4</td>
<td>2012-11-10</td>
<td>2013-11-09</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>5</td>
<td>2013-11-10</td>
<td>2014-11-09</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>9</td>
<td>2017-11-10</td>
<td>2018-11-09</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>10</td>
<td>2018-11-10</td>
<td>2019-11-09</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>11</td>
<td>2019-11-10</td>
<td>2020-11-09</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>2009-11-10</td>
<td>null</td>
<td>12</td>
<td>2020-11-10</td>
<td>2021-11-09</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Surrender"</td>
<td>2009-11-10</td>
<td>2022-02-25</td>
<td>13</td>
<td>2021-11-10</td>
<td>2022-11-09</td>
<td>0.29589</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="study-start-date" class="level3">
<h3 class="anchored" data-anchor-id="study-start-date">Study start date</h3>
<p>The previous section only supplied data and a study <code>end_date</code> to <code>ExposedDF()</code>. This is the minimum required arguments for the function. Optionally, a <code>start_date</code> can be supplied that will drop exposure periods that begin before a specified date.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>, start_date<span class="op">=</span><span class="st">"2019-12-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expose-start" class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Exposure data

Exposure type: policy_year
Target status: None
Study range: 2019-12-31 to 2022-12-31

shape: (6, 8)
┌─────────┬───────────┬────────────┬────────────┬────────┬─────────────┬────────────────┬──────────┐
│ pol_num ┆ status    ┆ issue_date ┆ term_date  ┆ pol_yr ┆ pol_date_yr ┆ pol_date_yr_en ┆ exposure │
│ ---     ┆ ---       ┆ ---        ┆ ---        ┆ ---    ┆ ---         ┆ d              ┆ ---      │
│ i64     ┆ enum      ┆ date       ┆ date       ┆ u32    ┆ date        ┆ ---            ┆ f64      │
│         ┆           ┆            ┆            ┆        ┆             ┆ date           ┆          │
╞═════════╪═══════════╪════════════╪════════════╪════════╪═════════════╪════════════════╪══════════╡
│ 1       ┆ Active    ┆ 2010-01-01 ┆ null       ┆ 11     ┆ 2020-01-01  ┆ 2020-12-31     ┆ 1.0      │
│ 1       ┆ Active    ┆ 2010-01-01 ┆ null       ┆ 12     ┆ 2021-01-01  ┆ 2021-12-31     ┆ 1.0      │
│ 1       ┆ Active    ┆ 2010-01-01 ┆ null       ┆ 13     ┆ 2022-01-01  ┆ 2022-12-31     ┆ 1.0      │
│ 2       ┆ Death     ┆ 2011-05-27 ┆ 2020-09-14 ┆ 10     ┆ 2020-05-27  ┆ 2021-05-26     ┆ 0.30411  │
│ 3       ┆ Active    ┆ 2009-11-10 ┆ null       ┆ 12     ┆ 2020-11-10  ┆ 2021-11-09     ┆ 1.0      │
│ 3       ┆ Surrender ┆ 2009-11-10 ┆ 2022-02-25 ┆ 13     ┆ 2021-11-10  ┆ 2022-11-09     ┆ 0.29589  │
└─────────┴───────────┴────────────┴────────────┴────────┴─────────────┴────────────────┴──────────┘</code></pre>
</div>
</div>
</section>
<section id="target-status" class="level3">
<h3 class="anchored" data-anchor-id="target-status">Target status</h3>
<p>Most experience studies use the annual exposure method which allocates a full period of exposure for the particular termination event of interest in the scope of the study.</p>
<p>The intuition for this approach is simple: let’s assume we have an unrealistically small study with a single data point for one policy over the course of one year. Let’s assume that policy terminated due to surrender half way through the year.</p>
<p>If we don’t apply the annual exposure method, we would calculate a termination rate as:</p>
<p><span class="math display">\[
q^{surr} = \frac{claims}{exposures} = \frac{1}{0.5} = 200\%
\]</span></p>
<p>A termination rate of 200% doesn’t make any sense. Under the annual exposure method we would see a rate of 100%, which is intuitive.</p>
<p><span class="math display">\[
q^{surr} = \frac{claims}{exposures} = \frac{1}{1} = 100\%
\]</span></p>
<p>The annual exposure method can be applied by passing a character vector of target statuses to the <code>ExposedDF()</code> class.</p>
<p>Let’s assume we are performing a surrender study.</p>
<div id="expose-targ" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>exposed_data2 <span class="op">=</span> xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                             target_status<span class="op">=</span><span class="st">"Surrender"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s verify that the exposure on the surrendered policy increased to 100% in the last exposure period.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>exposed_data2.data.group_by(<span class="st">'pol_num'</span>).tail(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expose-targ-check" class="cell-output cell-output-display" data-execution_count="9">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (3, 8)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr</th>
<th data-quarto-table-cell-role="th">pol_date_yr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>u32</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>2010-01-01</td>
<td>null</td>
<td>13</td>
<td>2022-01-01</td>
<td>2022-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Death"</td>
<td>2011-05-27</td>
<td>2020-09-14</td>
<td>10</td>
<td>2020-05-27</td>
<td>2021-05-26</td>
<td>0.30411</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Surrender"</td>
<td>2009-11-10</td>
<td>2022-02-25</td>
<td>13</td>
<td>2021-11-10</td>
<td>2022-11-09</td>
<td>1.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="other-exposure-periods" class="level2">
<h2 class="anchored" data-anchor-id="other-exposure-periods">Other exposure periods</h2>
<p>The default exposure basis used by <code>ExposedDF()</code> is policy years. Using the arguments <code>cal_expo</code> and <code>expo_length</code> other exposure periods can be used.</p>
<section id="calendar-years" class="level3">
<h3 class="anchored" data-anchor-id="calendar-years">Calendar years</h3>
<p>If <code>cal_expo</code> is set to <code>True</code>, calendar year exposures will be calculated.</p>
<p>Looking at the second policy, we can see that the first year is left-censored because the policy was issued two-fifths of the way through the year, and the last period is right-censored because the policy terminated roughly seven-tenths of the way through the year.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>exposed_cal <span class="op">=</span> xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                           cal_expo<span class="op">=</span><span class="va">True</span>, target_status<span class="op">=</span><span class="st">"Surrender"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>exposed_cal.data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expo-cal" class="cell-output cell-output-display" data-execution_count="10">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 7)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">cal_yr</th>
<th data-quarto-table-cell-role="th">cal_yr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2011-01-01</td>
<td>2011-12-31</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2012-01-01</td>
<td>2012-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2013-01-01</td>
<td>2013-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2014-01-01</td>
<td>2014-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2015-01-01</td>
<td>2015-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2016-01-01</td>
<td>2016-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2017-01-01</td>
<td>2017-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2018-01-01</td>
<td>2018-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2019-01-01</td>
<td>2019-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Death"</td>
<td>2011-05-27</td>
<td>2020-09-14</td>
<td>2020-01-01</td>
<td>2020-12-31</td>
<td>0.704918</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="quarters-months-and-weeks" class="level3">
<h3 class="anchored" data-anchor-id="quarters-months-and-weeks">Quarters, months, and weeks</h3>
<p>The length of the exposure period can be decreased by passing <code>"quarter"</code>, <code>"month"</code>, or <code>"week"</code> to the <code>expo_length</code> argument. This can be used with policy or calendar-based exposures.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>, cal_expo<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>              expo_length<span class="op">=</span><span class="st">"quarter"</span>, target_status<span class="op">=</span><span class="st">"Surrender"</span>).</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>              data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expo-mth" class="cell-output cell-output-display" data-execution_count="11">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (38, 7)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">issue_date</th>
<th data-quarto-table-cell-role="th">term_date</th>
<th data-quarto-table-cell-role="th">cal_qtr</th>
<th data-quarto-table-cell-role="th">cal_qtr_end</th>
<th data-quarto-table-cell-role="th">exposure</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>date</th>
<th>date</th>
<th>date</th>
<th>date</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2011-04-01</td>
<td>2011-06-30</td>
<td>0.384615</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2011-07-01</td>
<td>2011-09-30</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2011-10-01</td>
<td>2011-12-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2012-01-01</td>
<td>2012-03-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2012-04-01</td>
<td>2012-06-30</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2019-07-01</td>
<td>2019-09-30</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2019-10-01</td>
<td>2019-12-31</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2020-01-01</td>
<td>2020-03-31</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2</td>
<td>"Active"</td>
<td>2011-05-27</td>
<td>null</td>
<td>2020-04-01</td>
<td>2020-06-30</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2</td>
<td>"Death"</td>
<td>2011-05-27</td>
<td>2020-09-14</td>
<td>2020-07-01</td>
<td>2020-09-30</td>
<td>0.826087</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="convenience-functions" class="level3">
<h3 class="anchored" data-anchor-id="convenience-functions">Convenience functions</h3>
<p>The following functions are class methods of <code>ExposedDF()</code> that target a specific exposure type without specifying <code>cal_expo</code> and <code>expo_length</code>.</p>
<ul>
<li><code>ExposedDF.expose_py()</code> = exposures by policy year</li>
<li><code>ExposedDF.expose_pq()</code> = exposures by policy quarter</li>
<li><code>ExposedDF.expose_pm()</code> = exposures by policy month</li>
<li><code>ExposedDF.expose_pw()</code> = exposures by policy week</li>
<li><code>ExposedDF.expose_cy()</code> = exposures by calendar year</li>
<li><code>ExposedDF.expose_cq()</code> = exposures by calendar quarter</li>
<li><code>ExposedDF.expose_cm()</code> = exposures by calendar month</li>
<li><code>ExposedDF.expose_cw()</code> = exposures by calendar week</li>
</ul>
</section>
</section>
<section id="split-exposures-by-calendar-period-and-policy-year" class="level2">
<h2 class="anchored" data-anchor-id="split-exposures-by-calendar-period-and-policy-year">Split exposures by calendar period and policy year</h2>
<p>A common technique used in experience studies is to split calendar years into two records: a pre-anniversary record and a post-anniversary record. In actxps, this can be accomplished using the <code>expose_split()</code> method.</p>
<p>Let’s continue examining the second policy. <code>exposed_cal</code>, which contains calendar year exposures, is passed into <code>expose_split()</code>. The resulting data now contains 19 records instead of 10. There is one record for 2011 and 2 records for all other years. The year 2011 only has a single record because the policy was issued in this year, so there can only be a post-anniversary record.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>split <span class="op">=</span> exposed_cal.expose_split()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>(split.data.</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a> <span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">2</span>).</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a> select(<span class="st">'cal_yr'</span>, <span class="st">'cal_yr_end'</span>, <span class="st">'pol_yr'</span>, <span class="st">'exposure_pol'</span>, <span class="st">'exposure_cal'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="expo-split" class="cell-output cell-output-display" data-execution_count="12">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (19, 5)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">cal_yr</th>
<th data-quarto-table-cell-role="th">cal_yr_end</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">exposure_pol</th>
<th data-quarto-table-cell-role="th">exposure_cal</th>
</tr>
<tr class="odd">
<th>date</th>
<th>date</th>
<th>i32</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2011-05-27</td>
<td>2011-12-31</td>
<td>1</td>
<td>0.598361</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2012-01-01</td>
<td>2012-05-26</td>
<td>1</td>
<td>0.401639</td>
<td>0.401639</td>
</tr>
<tr class="odd">
<td>2012-05-27</td>
<td>2012-12-31</td>
<td>2</td>
<td>0.6</td>
<td>0.598361</td>
</tr>
<tr class="even">
<td>2013-01-01</td>
<td>2013-05-26</td>
<td>2</td>
<td>0.4</td>
<td>0.4</td>
</tr>
<tr class="odd">
<td>2013-05-27</td>
<td>2013-12-31</td>
<td>3</td>
<td>0.6</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2018-05-27</td>
<td>2018-12-31</td>
<td>8</td>
<td>0.6</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2019-01-01</td>
<td>2019-05-26</td>
<td>8</td>
<td>0.4</td>
<td>0.4</td>
</tr>
<tr class="odd">
<td>2019-05-27</td>
<td>2019-12-31</td>
<td>9</td>
<td>0.598361</td>
<td>0.6</td>
</tr>
<tr class="even">
<td>2020-01-01</td>
<td>2020-05-26</td>
<td>9</td>
<td>0.401639</td>
<td>0.401639</td>
</tr>
<tr class="odd">
<td>2020-05-27</td>
<td>2020-12-31</td>
<td>10</td>
<td>0.30411</td>
<td>0.303279</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The output of <code>expose_split()</code> contains two exposure columns.</p>
<ul>
<li><code>exposure_pol</code> contains policy year exposures</li>
<li><code>exposure_cal</code> contains calendar year exposures</li>
</ul>
<p>The two exposure bases will often not match for two reasons:</p>
<ol type="1">
<li><p>Calendar years and policy years have different start and end dates that may or may not include a leap day. In the first row, the calendar year exposure is 0.6 years of the year 2011, which does not include a leap day. In the second row, the policy year exposure is 0.5984 years of the policy year spanning 2011-05-27 to 2012-05-26, which does include a leap day.</p></li>
<li><p>Application of the annual exposure method. If the termination event of interest appears on a post-anniversary record, policy exposures will be 1 and calendar exposures will be the fraction of the year spanning the anniversary to December 31st. Conversely, if the termination event of interest appears on a pre-anniversary record, calendar exposures will be 1 and policy exposures will be the fraction of the policy year from January 1st to the last day of the current policy year. While it may sound confusing at first, these rules are important to ensure that the termination event of interest always has an exposure of 1 when the data is grouped on a calendar year or policy year basis.</p></li>
</ol>
<p>Some downstream methods like <code>exp_stats()</code> expect <code>ExposedDF</code> objects to have a single column for exposures. For split exposures, the exposure basis must be specified using the <code>col_exposure</code> argument.</p>
<div id="split-stats-unclear" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>split.exp_stats()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="split-stats-unclear-cat" class="cell" data-execution_count="14">
<div class="cell-output cell-output-stdout">
<pre><code>A `SplitExposedDF` was passed without clarifying which exposure basis should be used to summarize results. Hint: Pass "exposure_pol" to `col_exposure` for policy year exposures pass "exposure_cal" to `col_exposure` for calendar exposures.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>split.exp_stats(col_exposure<span class="op">=</span><span class="st">"exposure_pol"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="split-stats-clear" class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Experience study results

Target status: Surrender
Study range: 1900-01-01 to 2022-12-31

shape: (1, 4)
┌──────────┬────────┬──────────┬──────────┐
│ n_claims ┆ claims ┆ exposure ┆ q_obs    │
│ ---      ┆ ---    ┆ ---      ┆ ---      │
│ u32      ┆ u32    ┆ f64      ┆ f64      │
╞══════════╪════════╪══════════╪══════════╡
│ 1        ┆ 1      ┆ 35.30411 ┆ 0.028325 │
└──────────┴────────┴──────────┴──────────┘</code></pre>
</div>
</div>
<p><code>expose_split()</code> doesn’t just work with calendar year exposures. Calendar quarters, months, or weeks can also be split. For periods shorter than a year, a record is only split into pre- and post-anniversary segments if a policy anniversary appears in the middle of the period.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(xp.ExposedDF.expose_cq(toy_census, <span class="st">"2022-12-31"</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                        target_status<span class="op">=</span><span class="st">"Surrender"</span>).</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    expose_split().</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    data.<span class="bu">filter</span>(pl.col(<span class="st">'pol_num'</span>) <span class="op">==</span> <span class="dv">2</span>).</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    select(<span class="st">'cal_qtr'</span>, <span class="st">'cal_qtr_end'</span>, <span class="st">'pol_yr'</span>, <span class="st">'exposure_pol'</span>, <span class="st">'exposure_cal'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="split-qtr" class="cell-output cell-output-display" data-execution_count="15">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (47, 5)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">cal_qtr</th>
<th data-quarto-table-cell-role="th">cal_qtr_end</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">exposure_pol</th>
<th data-quarto-table-cell-role="th">exposure_cal</th>
</tr>
<tr class="odd">
<th>date</th>
<th>date</th>
<th>i32</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2011-05-27</td>
<td>2011-06-30</td>
<td>1</td>
<td>0.095628</td>
<td>0.384615</td>
</tr>
<tr class="even">
<td>2011-07-01</td>
<td>2011-09-30</td>
<td>1</td>
<td>0.251366</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2011-10-01</td>
<td>2011-12-31</td>
<td>1</td>
<td>0.251366</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2012-01-01</td>
<td>2012-03-31</td>
<td>1</td>
<td>0.248634</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2012-04-01</td>
<td>2012-05-26</td>
<td>1</td>
<td>0.153005</td>
<td>0.615385</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2019-10-01</td>
<td>2019-12-31</td>
<td>9</td>
<td>0.251366</td>
<td>1.0</td>
</tr>
<tr class="even">
<td>2020-01-01</td>
<td>2020-03-31</td>
<td>9</td>
<td>0.248634</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td>2020-04-01</td>
<td>2020-05-26</td>
<td>9</td>
<td>0.153005</td>
<td>0.615385</td>
</tr>
<tr class="even">
<td>2020-05-27</td>
<td>2020-06-30</td>
<td>10</td>
<td>0.09589</td>
<td>0.384615</td>
</tr>
<tr class="odd">
<td>2020-07-01</td>
<td>2020-09-30</td>
<td>10</td>
<td>0.208219</td>
<td>0.826087</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Note, however, that calendar period exposures will always be expressed in the original units and policy exposures will always be expressed in years. Above, calendar exposures are quarters whereas policy exposures are years.</p>
</section>
<section id="miscellaneous" class="level2">
<h2 class="anchored" data-anchor-id="miscellaneous">Miscellaneous</h2>
<section id="column-names" class="level3">
<h3 class="anchored" data-anchor-id="column-names">Column names</h3>
<p>As a default, <code>ExposedDF()</code> assumes the census data frame uses the following naming conventions:</p>
<ul>
<li>The policy number column is called <code>pol_num</code></li>
<li>The status column is called <code>status</code></li>
<li>The issue date column is called <code>issue_date</code></li>
<li>The termination date column is called <code>term_date</code></li>
</ul>
<p>These default names can be overridden using the <code>col_pol_num</code>, <code>col_status</code>, <code>col_issue_date</code>, and <code>col_term_date</code> arguments.</p>
<p>For example, if the policy number column was called <code>id</code> in our census-level data, we could write:</p>
<div id="col-names" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>xp.ExposedDF(toy_census, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>, target_status<span class="op">=</span><span class="st">"Surrender"</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>             col_pol_num<span class="op">=</span><span class="st">"id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="treatment-of-additional-columns-in-the-census-data" class="level3">
<h3 class="anchored" data-anchor-id="treatment-of-additional-columns-in-the-census-data">Treatment of additional columns in the census data</h3>
<p>If the census-level data contains other policy attributes like plan type or policy values, they will be broadcast across all exposure periods. Depending on the nature of the data, this may or may not be desirable. Constant policy attributes like plan type make sense to broadcast, but numeric values may or may not depending on the circumstances.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>toy_census2 <span class="op">=</span> toy_census.clone().with_columns(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    plan_type<span class="op">=</span>pl.Series([<span class="st">"X"</span>, <span class="st">"Y"</span>, <span class="st">"Z"</span>]),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    policy_value<span class="op">=</span>pl.Series([<span class="dv">100</span>, <span class="dv">125</span>, <span class="dv">90</span>])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>(xp.ExposedDF(toy_census2, end_date<span class="op">=</span><span class="st">"2022-12-31"</span>, target_status<span class="op">=</span><span class="st">"Surrender"</span>).</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>     data.select(<span class="st">'pol_num'</span>, <span class="st">'status'</span>, <span class="st">'pol_yr'</span>, <span class="st">'exposure'</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'plan_type'</span>, <span class="st">'policy_value'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="broadcast" class="cell-output cell-output-display" data-execution_count="16">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (36, 6)</small>
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">exposure</th>
<th data-quarto-table-cell-role="th">plan_type</th>
<th data-quarto-table-cell-role="th">policy_value</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>enum</th>
<th>u32</th>
<th>f64</th>
<th>str</th>
<th>i64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>1</td>
<td>1.0</td>
<td>"X"</td>
<td>100</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>2</td>
<td>1.0</td>
<td>"X"</td>
<td>100</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>3</td>
<td>1.0</td>
<td>"X"</td>
<td>100</td>
</tr>
<tr class="even">
<td>1</td>
<td>"Active"</td>
<td>4</td>
<td>1.0</td>
<td>"X"</td>
<td>100</td>
</tr>
<tr class="odd">
<td>1</td>
<td>"Active"</td>
<td>5</td>
<td>1.0</td>
<td>"X"</td>
<td>100</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>9</td>
<td>1.0</td>
<td>"Z"</td>
<td>90</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>10</td>
<td>1.0</td>
<td>"Z"</td>
<td>90</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Active"</td>
<td>11</td>
<td>1.0</td>
<td>"Z"</td>
<td>90</td>
</tr>
<tr class="even">
<td>3</td>
<td>"Active"</td>
<td>12</td>
<td>1.0</td>
<td>"Z"</td>
<td>90</td>
</tr>
<tr class="odd">
<td>3</td>
<td>"Surrender"</td>
<td>13</td>
<td>1.0</td>
<td>"Z"</td>
<td>90</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>If your experience study requires a numeric feature that varies over time (ex: policy values, crediting rates, etc.), you can always attach it to an <code>ExposedDF</code> object’s <code>data</code> using a join function.</p>
<div id="join-ex" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Illustrative example - assume `values` is a data frame containing the columns pol_num and pol_yr.</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>exposed_data.data.join(values, on<span class="op">=</span>[<span class="st">'pol_num'</span>, <span class="st">'pol_yr'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<p><code>ExposedDF()</code> does not support studies with multiple changes between an active status and an inactive status.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>