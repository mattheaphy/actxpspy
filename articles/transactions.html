<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>actxps - Transaction studies</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">actxps</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../articles/actxps.html" rel="" target="">
 <span class="menu-text">Get started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference/index.html" rel="" target="">
 <span class="menu-text">Reference</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-articles" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Articles</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-articles">    
        <li>
    <a class="dropdown-item" href="../articles/exposures.html" rel="" target="">
 <span class="dropdown-text">Exposure calculations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/exp_summary.html" rel="" target="">
 <span class="dropdown-text">Experience summaries</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/transactions.html" rel="" target="">
 <span class="dropdown-text">Transaction studies</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/visualizations.html" rel="" target="">
 <span class="dropdown-text">Data visualizations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../articles/misc.html" rel="" target="">
 <span class="dropdown-text">Other functions</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../changelog.html" rel="" target="">
 <span class="menu-text">Changelog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mattheaphy/actxpspy" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-r-circle-fill" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-r-circle-fill" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-r-circle-fill">    
        <li class="dropdown-header">R version of actxps</li>
        <li>
    <a class="dropdown-item" href="https://github.com/mattheaphy/actxps" rel="" target="">
 <span class="dropdown-text">Source code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mattheaphy.github.io/actxps" rel="" target="">
 <span class="dropdown-text">Package documentation</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#simulated-transaction-and-account-value-data" id="toc-simulated-transaction-and-account-value-data" class="nav-link active" data-scroll-target="#simulated-transaction-and-account-value-data">Simulated transaction and account value data</a></li>
  <li><a href="#the-add_transactions-method" id="toc-the-add_transactions-method" class="nav-link" data-scroll-target="#the-add_transactions-method">The <code>add_transactions()</code> method</a></li>
  <li><a href="#the-trx_stats-method" id="toc-the-trx_stats-method" class="nav-link" data-scroll-target="#the-trx_stats-method">The <code>trx_stats()</code> method</a>
  <ul class="collapse">
  <li><a href="#grouped-data" id="toc-grouped-data" class="nav-link" data-scroll-target="#grouped-data">Grouped data</a></li>
  </ul></li>
  <li><a href="#expressing-transactions-as-a-percentage-of-another-value" id="toc-expressing-transactions-as-a-percentage-of-another-value" class="nav-link" data-scroll-target="#expressing-transactions-as-a-percentage-of-another-value">Expressing transactions as a percentage of another value</a></li>
  <li><a href="#confidence-intervals" id="toc-confidence-intervals" class="nav-link" data-scroll-target="#confidence-intervals">Confidence intervals</a></li>
  <li><a href="#plot-and-table" id="toc-plot-and-table" class="nav-link" data-scroll-target="#plot-and-table"><code>plot()</code> and <code>table()</code></a></li>
  <li><a href="#miscellaneous" id="toc-miscellaneous" class="nav-link" data-scroll-target="#miscellaneous">Miscellaneous</a>
  <ul class="collapse">
  <li><a href="#selecting-and-combining-transaction-types" id="toc-selecting-and-combining-transaction-types" class="nav-link" data-scroll-target="#selecting-and-combining-transaction-types">Selecting and combining transaction types</a></li>
  <li><a href="#partial-exposures-are-removed-as-a-default" id="toc-partial-exposures-are-removed-as-a-default" class="nav-link" data-scroll-target="#partial-exposures-are-removed-as-a-default">Partial exposures are removed as a default</a></li>
  <li><a href="#summary-method" id="toc-summary-method" class="nav-link" data-scroll-target="#summary-method">Summary method</a></li>
  <li><a href="#column-names" id="toc-column-names" class="nav-link" data-scroll-target="#column-names">Column names</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Transaction studies</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This article walks through an example of creating a <strong>transaction study</strong> using the actxps package. Unlike a termination study, transaction studies track events that can occur multiple times over the life of a policy. Often, transactions are expected to reoccur; for example, the utilization of a guaranteed income stream.</p>
<p>Key questions to answer in a transaction study are:</p>
<ul>
<li>What types of transactions occurred?</li>
<li>What is the count, amount, and average size of observed transactions?</li>
<li>What percentage of policies have transactions each exposure period?</li>
<li>How do transactions compare to expectations?</li>
<li>What is the rate of transaction amounts as a percentage of another value?</li>
</ul>
<p>The example below walks through preparing data by adding transaction information to an <code>ExposedDF</code> object using the <code>add_transactions()</code> method. Next, study results are summarized using the <code>trx_stats()</code> method.</p>
<section id="simulated-transaction-and-account-value-data" class="level2">
<h2 class="anchored" data-anchor-id="simulated-transaction-and-account-value-data">Simulated transaction and account value data</h2>
<p>In this example, we’ll be using the <code>census_dat</code>, <code>withdrawals</code>, and <code>account_vals</code> data sets. Each data set is based on a theoretical block of deferred annuity business with a guaranteed lifetime income benefit.</p>
<ul>
<li><code>census_dat</code> contains census-level information with one row per policy</li>
<li><code>withdrawals</code> contains withdrawal transactions. There are 2 types of transactions in the data: “Base” (ordinary withdrawals) and “Rider” (guaranteed income payments).</li>
<li><code>account_vals</code> contains historical account values on policy anniversaries. This data will be used to calculate withdrawal rates as a percentage of account values.</li>
</ul>
</section>
<section id="the-add_transactions-method" class="level2">
<h2 class="anchored" data-anchor-id="the-add_transactions-method">The <code>add_transactions()</code> method</h2>
<p>The <code>add_transactions()</code> method attaches transactions to an <code>ExposedDF</code> object, which contains a data frame with exposure-level records. For our example, we first need to convert <code>census_dat</code> into exposure records using <code>ExposedDF()</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> This example will use policy year exposures.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> actxps <span class="im">as</span> xp</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>census_dat <span class="op">=</span> xp.load_census_dat()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>exposed_data <span class="op">=</span> xp.ExposedDF(census_dat, <span class="st">"2019-12-31"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                            target_status<span class="op">=</span><span class="st">"Surrender"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>exposed_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="packages" class="cell-output cell-output-display" data-execution_count="2">
<pre><code>Exposure data

Exposure type: policy_year
Target status: Surrender
Study range: 1900-01-01 to 2019-12-31

A DataFrame: 141,252 x 15
   pol_num  status issue_date  inc_guar   qual  age product gender  wd_age  \
0        1  Active 2014-12-17      True  False   56       b      F      77   
1        1  Active 2014-12-17      True  False   56       b      F      77   
2        1  Active 2014-12-17      True  False   56       b      F      77   
3        1  Active 2014-12-17      True  False   56       b      F      77   
4        1  Active 2014-12-17      True  False   56       b      F      77   
5        1  Active 2014-12-17      True  False   56       b      F      77   
6        2  Active 2007-09-24     False  False   71       a      F      71   
7        2  Active 2007-09-24     False  False   71       a      F      71   
8        2  Active 2007-09-24     False  False   71       a      F      71   
9        2  Active 2007-09-24     False  False   71       a      F      71   

   premium term_date  pol_yr pol_date_yr pol_date_yr_end  exposure  
0    370.0       NaT       1  2014-12-17      2015-12-16  1.000000  
1    370.0       NaT       2  2015-12-17      2016-12-16  1.000000  
2    370.0       NaT       3  2016-12-17      2017-12-16  1.000000  
3    370.0       NaT       4  2017-12-17      2018-12-16  1.000000  
4    370.0       NaT       5  2018-12-17      2019-12-16  1.000000  
5    370.0       NaT       6  2019-12-17      2020-12-16  0.040984  
6    708.0       NaT       1  2007-09-24      2008-09-23  1.000000  
7    708.0       NaT       2  2008-09-24      2009-09-23  1.000000  
8    708.0       NaT       3  2009-09-24      2010-09-23  1.000000  
9    708.0       NaT       4  2010-09-24      2011-09-23  1.000000  </code></pre>
</div>
</div>
<p>The <code>withdrawals</code> data has 4 columns that are required for attaching transactions:</p>
<ul>
<li><code>pol_num</code>: policy number</li>
<li><code>trx_date</code>: transaction date</li>
<li><code>trx_type</code>: transaction type</li>
<li><code>trx_amt</code>: transaction amount</li>
</ul>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>withdrawals <span class="op">=</span> xp.load_withdrawals()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>withdrawals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="wd-head" class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pol_num</th>
<th data-quarto-table-cell-role="th">trx_date</th>
<th data-quarto-table-cell-role="th">trx_type</th>
<th data-quarto-table-cell-role="th">trx_amt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2</td>
<td>2007-10-05</td>
<td>Base</td>
<td>25.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>2009-07-30</td>
<td>Base</td>
<td>12.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2010-02-22</td>
<td>Base</td>
<td>7.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2</td>
<td>2010-12-30</td>
<td>Base</td>
<td>52.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2</td>
<td>2012-05-07</td>
<td>Base</td>
<td>41.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">160125</td>
<td>20000</td>
<td>2015-08-08</td>
<td>Rider</td>
<td>547.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">160126</td>
<td>20000</td>
<td>2016-07-26</td>
<td>Rider</td>
<td>106.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">160127</td>
<td>20000</td>
<td>2017-12-29</td>
<td>Rider</td>
<td>31.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">160128</td>
<td>20000</td>
<td>2018-06-14</td>
<td>Rider</td>
<td>75.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">160129</td>
<td>20000</td>
<td>2019-12-09</td>
<td>Rider</td>
<td>466.0</td>
</tr>
</tbody>
</table>

<p>160130 rows × 4 columns</p>
</div>
</div>
</div>
<p>The grain of this data is one row per policy per transaction. The expectation is that the number of records in the transaction data will not match the number of rows in the exposure data. That is because policies could have zero or several transactions in a given exposure period.</p>
<p>The <code>add_transactions()</code> method uses a non-equivalent join to associate each transaction with a policy number and a date interval found in the exposure data. Then, transaction counts and amounts are summarized such that there is one row per exposure period. In the event there are multiple transaction types found in the data, separate columns are created for each transaction type.</p>
<p>Using our example, we pass both the exposure and withdrawals data to <code>add_transactions()</code>. The resulting data has the same number of rows as original exposure data and 4 new columns:</p>
<ul>
<li><code>trx_amt_Base</code>: the sum of “Base” withdrawal transactions</li>
<li><code>trx_amt_Rider</code>: the sum of “Rider” withdrawal transactions</li>
<li><code>trx_n_Base</code>: the number of “Base” withdrawal transactions</li>
<li><code>trx_n_Rider</code>: the number of “Rider” withdrawal transactions</li>
</ul>
<div id="add-trx" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>exposed_data.add_transactions(withdrawals)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>exposed_data.data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 141252 entries, 0 to 141251
Data columns (total 19 columns):
 #   Column           Non-Null Count   Dtype         
---  ------           --------------   -----         
 0   pol_num          141252 non-null  int32         
 1   status           141252 non-null  category      
 2   issue_date       141252 non-null  datetime64[ns]
 3   inc_guar         141252 non-null  bool          
 4   qual             141252 non-null  bool          
 5   age              141252 non-null  int32         
 6   product          141252 non-null  category      
 7   gender           141252 non-null  category      
 8   wd_age           141252 non-null  int32         
 9   premium          141252 non-null  float64       
 10  term_date        4639 non-null    datetime64[ns]
 11  pol_yr           141252 non-null  int64         
 12  pol_date_yr      141252 non-null  datetime64[ns]
 13  pol_date_yr_end  141252 non-null  datetime64[ns]
 14  exposure         141252 non-null  float64       
 15  trx_amt_Base     141252 non-null  float64       
 16  trx_amt_Rider    141252 non-null  float64       
 17  trx_n_Base       141252 non-null  float64       
 18  trx_n_Rider      141252 non-null  float64       
dtypes: bool(2), category(3), datetime64[ns](4), float64(6), int32(3), int64(1)
memory usage: 14.1 MB</code></pre>
</div>
</div>
<p>If we print <code>exposed_data</code>, we can see that it has an additional attribute for transaction types that have been attached.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>exposed_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="print-trx-types" class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Exposure data

Exposure type: policy_year
Target status: Surrender
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider

A DataFrame: 141,252 x 19
   pol_num  status issue_date  inc_guar   qual  age product gender  wd_age  \
0        1  Active 2014-12-17      True  False   56       b      F      77   
1        1  Active 2014-12-17      True  False   56       b      F      77   
2        1  Active 2014-12-17      True  False   56       b      F      77   
3        1  Active 2014-12-17      True  False   56       b      F      77   
4        1  Active 2014-12-17      True  False   56       b      F      77   
5        1  Active 2014-12-17      True  False   56       b      F      77   
6        2  Active 2007-09-24     False  False   71       a      F      71   
7        2  Active 2007-09-24     False  False   71       a      F      71   
8        2  Active 2007-09-24     False  False   71       a      F      71   
9        2  Active 2007-09-24     False  False   71       a      F      71   

   premium term_date  pol_yr pol_date_yr pol_date_yr_end  exposure  \
0    370.0       NaT       1  2014-12-17      2015-12-16  1.000000   
1    370.0       NaT       2  2015-12-17      2016-12-16  1.000000   
2    370.0       NaT       3  2016-12-17      2017-12-16  1.000000   
3    370.0       NaT       4  2017-12-17      2018-12-16  1.000000   
4    370.0       NaT       5  2018-12-17      2019-12-16  1.000000   
5    370.0       NaT       6  2019-12-17      2020-12-16  0.040984   
6    708.0       NaT       1  2007-09-24      2008-09-23  1.000000   
7    708.0       NaT       2  2008-09-24      2009-09-23  1.000000   
8    708.0       NaT       3  2009-09-24      2010-09-23  1.000000   
9    708.0       NaT       4  2010-09-24      2011-09-23  1.000000   

   trx_amt_Base  trx_amt_Rider  trx_n_Base  trx_n_Rider  
0           0.0            0.0         0.0          0.0  
1           0.0            0.0         0.0          0.0  
2           0.0            0.0         0.0          0.0  
3           0.0            0.0         0.0          0.0  
4           0.0            0.0         0.0          0.0  
5           0.0            0.0         0.0          0.0  
6          25.0            0.0         1.0          0.0  
7          12.0            0.0         1.0          0.0  
8           7.0            0.0         1.0          0.0  
9          52.0            0.0         1.0          0.0  </code></pre>
</div>
</div>
</section>
<section id="the-trx_stats-method" class="level2">
<h2 class="anchored" data-anchor-id="the-trx_stats-method">The <code>trx_stats()</code> method</h2>
<p>The actxps package’s workhorse function for summarizing transaction experience is the <code>trx_stats()</code> method of the <code>ExposedDF</code> class. This function returns a <code>TrxStats</code> object, which is a type of data frame containing additional attributes about the transaction study.</p>
<p>At a minimum, a <code>TrxStats</code> includes the following for each transaction type (<code>trx_type</code>):</p>
<ul>
<li>The number of transactions (<code>trx_n</code>)</li>
<li>The number of exposure periods with a transaction (<code>trx_flag</code>)</li>
<li>The sum of transactions (<code>trx_amt</code>)</li>
<li>The total exposure (<code>exposure</code>)</li>
<li>The average transaction amount when a transaction occurs (<code>avg_trx</code>)</li>
<li>The average transaction amount across all records (<code>avg_all</code>)</li>
<li>The transaction frequency when a transaction occurs (<code>trx_freq = trx_n / trx_flag</code>)</li>
<li>The transaction utilization (<code>trx_util = trx_flag / exposure</code>)</li>
</ul>
<p>Optionally, a <code>TrxStats</code> can also include:</p>
<ul>
<li>Any grouping variables attached to the input data</li>
<li>Transaction amounts as a percentage of another value when a transaction occurs (<code>pct_of_*_w_trx</code>)</li>
<li>Transaction amounts as a percentage of another value across all records (<code>pct_of_*_all</code>)</li>
</ul>
<p>To use <code>trx_stats()</code>, we simply need to call the method from an <code>ExposedDF</code> object with transactions attached.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>exposed_data.trx_stats()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="trx-basic" class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Transaction study results

Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider


A DataFrame: 2 x 9
  trx_type    trx_n  trx_flag    trx_amt  exposure    avg_trx    avg_all  \
0     Base  60500.0     28224  1093899.0  124173.0  38.757759   8.809475   
1    Rider  77321.0     35941  2842729.0  124173.0  79.094321  22.893294   

   trx_freq  trx_util  
0  2.143566  0.227296  
1  2.151331  0.289443  </code></pre>
</div>
</div>
<p>The results show us that we specified no groups, which is why the output data contains a single row for each transaction type.</p>
<section id="grouped-data" class="level3">
<h3 class="anchored" data-anchor-id="grouped-data">Grouped data</h3>
<p>If the data is grouped using the <code>groupby()</code> method, future calls to <code>exp_stats()</code> will contain one record for each unique group.</p>
<p>If the data is grouped using the <code>groupby()</code> method, future calls to <code>trx_stats()</code> will contain one record for each unique group.</p>
<p>In the following, <code>exposed_data</code> is grouped by the presence of an income guarantee (<code>inc_guar</code>) before being passed to <code>trx_stats()</code>. This results in four rows because we have two types of transactions and two distinct values of <code>inc_guar</code>.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(exposed_data.</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    groupby(<span class="st">'inc_guar'</span>).</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    trx_stats())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="grouped-1" class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Transaction study results

Groups: inc_guar
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider


A DataFrame: 4 x 10
   inc_guar trx_type    trx_n  trx_flag    trx_amt  exposure    avg_trx  \
0     False     Base  52939.0     24703   952629.0   48938.0  38.563292   
1     False    Rider      0.0         0        0.0   48938.0        NaN   
2      True     Base   7561.0      3521   141270.0   75235.0  40.122124   
3      True    Rider  77321.0     35941  2842729.0   75235.0  79.094321   

     avg_all  trx_freq  trx_util  
0  19.466039  2.143019  0.504782  
1   0.000000       NaN  0.000000  
2   1.877716  2.147401  0.046800  
3  37.784661  2.151331  0.477716  </code></pre>
</div>
</div>
<p>Multiple grouping variables are allowed. Below, policy year (<code>pol_yr</code>) is added as a second grouping variable.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(exposed_data.</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    groupby(<span class="st">'inc_guar'</span>, <span class="st">'pol_yr'</span>).</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    trx_stats())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="grouped-2" class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Transaction study results

Groups: inc_guar, pol_yr
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider


A DataFrame: 60 x 11
   inc_guar  pol_yr trx_type   trx_n  trx_flag  trx_amt  exposure    avg_trx  \
0     False       1     Base  6077.0      2881  98287.0    7435.0  34.115585   
1     False       1    Rider     0.0         0      0.0    7435.0        NaN   
2     False       2     Base  6091.0      2863  98413.0    6813.0  34.374083   
3     False       2    Rider     0.0         0      0.0    6813.0        NaN   
4     False       3     Base  6016.0      2813  97285.0    6176.0  34.584074   
5     False       3    Rider     0.0         0      0.0    6176.0        NaN   
6     False       4     Base  5719.0      2664  99847.0    5490.0  37.480105   
7     False       4    Rider     0.0         0      0.0    5490.0        NaN   
8     False       5     Base  5354.0      2492  95070.0    4852.0  38.150080   
9     False       5    Rider     0.0         0      0.0    4852.0        NaN   

     avg_all  trx_freq  trx_util  
0  13.219502  2.109337  0.387492  
1   0.000000       NaN  0.000000  
2  14.444885  2.127489  0.420226  
3   0.000000       NaN  0.000000  
4  15.752105  2.138642  0.455473  
5   0.000000       NaN  0.000000  
6  18.187067  2.146772  0.485246  
7   0.000000       NaN  0.000000  
8  19.593982  2.148475  0.513603  
9   0.000000       NaN  0.000000  </code></pre>
</div>
</div>
</section>
</section>
<section id="expressing-transactions-as-a-percentage-of-another-value" class="level2">
<h2 class="anchored" data-anchor-id="expressing-transactions-as-a-percentage-of-another-value">Expressing transactions as a percentage of another value</h2>
<p>In a transaction study, we often want to express transaction amounts as a percentage of another value. For example, in a withdrawal study, withdrawal amounts divided by account values provides a withdrawal rate. In a study of benefit utilization, transactions can be divided by a maximum benefit amount to derive a benefit utilization rate. In addition, actual-to-expected rates can be calculated by dividing transactions by expected values.</p>
<p>If column names are passed to the <code>percent_of</code> argument of <code>trx_stats()</code>, the output will contain 4 additional columns for each “percent of” variable:</p>
<ul>
<li>The sum of each “percent of” variable</li>
<li>The sum of each “percent of” variable when a transaction occurs. These columns include the suffix <code>_w_trx</code>.</li>
<li>Transaction amounts divided by each “percent of” variable (<code>pct_of_{*}_all</code>)</li>
<li>Transaction amounts divided by each “percent of” variable when a transaction occurs (<code>pct_of_{*}_w_trx</code>)</li>
</ul>
<p>For our example, let’s assume we’re interested in examining withdrawal transactions as a percentage of account values, which are available in the <code>account_vals</code> data frame in the column <code>av_anniv</code>.</p>
<div id="pct-of" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># attach account values data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>account_vals <span class="op">=</span> xp.load_account_vals()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>exposed_data.data <span class="op">=</span> <span class="op">\</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    exposed_data.data.merge(account_vals,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                            on<span class="op">=</span>[<span class="st">'pol_num'</span>, <span class="st">'pol_date_yr'</span>],</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                            how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>trx_res <span class="op">=</span> (exposed_data.</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>           groupby(<span class="st">'pol_yr'</span>, <span class="st">'inc_guar'</span>).</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>           trx_stats(percent_of<span class="op">=</span><span class="st">"av_anniv"</span>))</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>trx_res.data.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 60 entries, 0 to 59
Data columns (total 15 columns):
 #   Column                 Non-Null Count  Dtype  
---  ------                 --------------  -----  
 0   pol_yr                 60 non-null     int64  
 1   inc_guar               60 non-null     bool   
 2   trx_type               60 non-null     object 
 3   trx_n                  60 non-null     float64
 4   trx_flag               60 non-null     int64  
 5   trx_amt                60 non-null     float64
 6   exposure               60 non-null     float64
 7   avg_trx                44 non-null     float64
 8   avg_all                60 non-null     float64
 9   trx_freq               44 non-null     float64
 10  trx_util               60 non-null     float64
 11  av_anniv               60 non-null     float64
 12  av_anniv_w_trx         60 non-null     float64
 13  pct_of_av_anniv_all    60 non-null     float64
 14  pct_of_av_anniv_w_trx  44 non-null     float64
dtypes: bool(1), float64(11), int64(2), object(1)
memory usage: 6.8+ KB</code></pre>
</div>
</div>
</section>
<section id="confidence-intervals" class="level2">
<h2 class="anchored" data-anchor-id="confidence-intervals">Confidence intervals</h2>
<p>If <code>conf_int</code> is set to <code>True</code>, <code>trx_stats()</code> will produce lower and upper confidence interval limits for the observed utilization rate. Confidence intervals are constructed assuming a binomial distribution.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(exposed_data.</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    groupby(<span class="st">'pol_yr'</span>).</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    trx_stats(conf_int<span class="op">=</span><span class="va">True</span>).</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    data[[<span class="st">'pol_yr'</span>, <span class="st">'trx_util'</span>, <span class="st">'trx_util_lower'</span>, <span class="st">'trx_util_upper'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="trx-conf1" class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">trx_util</th>
<th data-quarto-table-cell-role="th">trx_util_lower</th>
<th data-quarto-table-cell-role="th">trx_util_upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0.189526</td>
<td>0.183917</td>
<td>0.195189</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>0.203765</td>
<td>0.197994</td>
<td>0.209590</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>0.201638</td>
<td>0.195628</td>
<td>0.207707</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2</td>
<td>0.225915</td>
<td>0.219610</td>
<td>0.232220</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3</td>
<td>0.214912</td>
<td>0.208417</td>
<td>0.221407</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>13</td>
<td>0.516784</td>
<td>0.489461</td>
<td>0.544106</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">26</td>
<td>14</td>
<td>0.245645</td>
<td>0.210801</td>
<td>0.280488</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>14</td>
<td>0.550523</td>
<td>0.510453</td>
<td>0.590592</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>15</td>
<td>0.380952</td>
<td>0.190476</td>
<td>0.571429</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>15</td>
<td>0.428571</td>
<td>0.238095</td>
<td>0.619048</td>
</tr>
</tbody>
</table>

<p>30 rows × 4 columns</p>
</div>
</div>
</div>
<p>The default confidence level is 95%. This can be changed using the <code>conf_level</code> argument. Below, tighter confidence intervals are constructed by decreasing the confidence level to 90%.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(exposed_data.</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    groupby(<span class="st">'pol_yr'</span>).</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    trx_stats(conf_int<span class="op">=</span><span class="va">True</span>, conf_level<span class="op">=</span><span class="fl">0.9</span>).</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    data[[<span class="st">'pol_yr'</span>, <span class="st">'trx_util'</span>, <span class="st">'trx_util_lower'</span>, <span class="st">'trx_util_upper'</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="trx-conf2" class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pol_yr</th>
<th data-quarto-table-cell-role="th">trx_util</th>
<th data-quarto-table-cell-role="th">trx_util_lower</th>
<th data-quarto-table-cell-role="th">trx_util_upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0.189526</td>
<td>0.184780</td>
<td>0.194272</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>0.203765</td>
<td>0.198911</td>
<td>0.208619</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>0.201638</td>
<td>0.196571</td>
<td>0.206706</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2</td>
<td>0.225915</td>
<td>0.220671</td>
<td>0.231218</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3</td>
<td>0.214912</td>
<td>0.209456</td>
<td>0.220368</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>13</td>
<td>0.516784</td>
<td>0.494145</td>
<td>0.539422</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">26</td>
<td>14</td>
<td>0.245645</td>
<td>0.216028</td>
<td>0.275261</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">27</td>
<td>14</td>
<td>0.550523</td>
<td>0.515679</td>
<td>0.585366</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>15</td>
<td>0.380952</td>
<td>0.190476</td>
<td>0.571429</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>15</td>
<td>0.428571</td>
<td>0.238095</td>
<td>0.619048</td>
</tr>
</tbody>
</table>

<p>30 rows × 4 columns</p>
</div>
</div>
</div>
<p>If any column names are passed to <code>percent_of</code>, <code>trx_stats()</code> will produce additional confidence intervals:</p>
<ul>
<li>Intervals for transactions as a percentage of another column when transactions occur (<code>pct_of_{*}_w_trx</code>) are constructed using a normal distribution.</li>
<li>Intervals for transactions as a percentage of another column regardless of transaction utilization (<code>pct_of_{*}_all</code>) are calculated assuming that the aggregate distribution is normal with a mean equal to observed transactions and a variance equal to:</li>
</ul>
<p><span class="math display">\[
     Var(S) = E(N) \times Var(X) + E(X)^2 \times Var(N),
\]</span> Where <code>S</code> is the aggregate transactions random variable, <code>X</code> is an individual transaction amount assumed to follow a normal distribution, and <code>N</code> is a binomial random variable for transaction utilization.</p>
<div id="trx-conf3" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(exposed_data.</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    groupby(<span class="st">'pol_yr'</span>).</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    trx_stats(conf_int<span class="op">=</span><span class="va">True</span>, percent_of<span class="op">=</span><span class="st">"av_anniv"</span>).</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    data[[<span class="st">'pol_yr'</span>, <span class="st">'pct_of_av_anniv_all'</span>, <span class="st">'pct_of_av_anniv_w_trx'</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">'pct_of_av_anniv_w_trx_lower'</span>, <span class="st">'pct_of_av_anniv_w_trx_upper'</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">'pct_of_av_anniv_all_lower'</span>, <span class="st">'pct_of_av_anniv_all_upper'</span>]].</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 30 entries, 0 to 29
Data columns (total 7 columns):
 #   Column                       Non-Null Count  Dtype  
---  ------                       --------------  -----  
 0   pol_yr                       30 non-null     int64  
 1   pct_of_av_anniv_all          30 non-null     float64
 2   pct_of_av_anniv_w_trx        30 non-null     float64
 3   pct_of_av_anniv_w_trx_lower  30 non-null     float64
 4   pct_of_av_anniv_w_trx_upper  30 non-null     float64
 5   pct_of_av_anniv_all_lower    30 non-null     float64
 6   pct_of_av_anniv_all_upper    30 non-null     float64
dtypes: float64(6), int64(1)
memory usage: 1.8 KB</code></pre>
</div>
</div>
</section>
<section id="plot-and-table" class="level2">
<h2 class="anchored" data-anchor-id="plot-and-table"><code>plot()</code> and <code>table()</code></h2>
<p>The <code>plot()</code> and <code>table()</code> methods create visualizations and summary tables from <code>TrxStats</code> objects. See See <a href="../articles/visualizations.html">Visualizations</a> for full details on these functions.</p>
<div id="trx-plot" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>trx_res.plot(y<span class="op">=</span><span class="st">'pct_of_av_anniv_w_trx'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="transactions_files/figure-html/trx-plot-output-1.png" id="trx-plot-1" class="img-fluid"></p>
</div>
<div id="trx-plot-2" class="cell-output cell-output-display" data-execution_count="13">
<pre><code>&lt;Figure Size: (640 x 480)&gt;</code></pre>
</div>
</div>
<div id="trx-table" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first 10 rows showed for brevity</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>trx_res.table()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<center>
<img src="../images/trx_gt.png" width="65%" height="65%">
</center>
</section>
<section id="miscellaneous" class="level2">
<h2 class="anchored" data-anchor-id="miscellaneous">Miscellaneous</h2>
<section id="selecting-and-combining-transaction-types" class="level3">
<h3 class="anchored" data-anchor-id="selecting-and-combining-transaction-types">Selecting and combining transaction types</h3>
<p>The <code>trx_types</code> argument of <code>trx_stats()</code> selects a subset of transaction types that will appear in the output.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>exposed_data.trx_stats(trx_types<span class="op">=</span><span class="st">"Base"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="select-trx-type" class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Transaction study results

Groups: pol_yr
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base


A DataFrame: 15 x 10
   pol_yr trx_type   trx_n  trx_flag   trx_amt  exposure    avg_trx  \
0       1     Base  7447.0      3514  119877.0   18541.0  34.114115   
1       2     Base  7274.0      3422  116967.0   16971.0  34.180888   
2       3     Base  7061.0      3309  116357.0   15397.0  35.163796   
3       4     Base  6596.0      3080  114987.0   13790.0  37.333442   
4       5     Base  6093.0      2847  109918.0   12234.0  38.608360   
5       6     Base  5543.0      2572   97455.0   10697.0  37.890747   
6       7     Base  4921.0      2297   92797.0    9294.0  40.399216   
7       8     Base  4200.0      1964   85740.0    7783.0  43.655804   
8       9     Base  3579.0      1655   70715.0    6372.0  42.728097   
9      10     Base  3004.0      1376   57935.0    5052.0  42.103924   

     avg_all  trx_freq  trx_util  
0   6.465509  2.119237  0.189526  
1   6.892169  2.125658  0.201638  
2   7.557122  2.133877  0.214912  
3   8.338434  2.141558  0.223350  
4   8.984633  2.140148  0.232712  
5   9.110498  2.155132  0.240441  
6   9.984614  2.142360  0.247149  
7  11.016318  2.138493  0.252345  
8  11.097772  2.162538  0.259730  
9  11.467736  2.183140  0.272367  </code></pre>
</div>
</div>
<p>If the <code>combine_trx</code> argument is set to <code>True</code>, all transaction types will be combined in a group called “All” in the output.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>exposed_data.trx_stats(combine_trx<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="combine-trx" class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Transaction study results

Groups: pol_yr
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider


A DataFrame: 15 x 10
   pol_yr trx_type    trx_n  trx_flag   trx_amt  exposure    avg_trx  \
0       1      All  15524.0      7292  385189.0   18541.0  52.823505   
1       2      All  15506.0      7256  405081.0   16971.0  55.827040   
2       3      All  15265.0      7126  411152.0   15397.0  57.697446   
3       4      All  14556.0      6795  398750.0   13790.0  58.682855   
4       5      All  13629.0      6368  374857.0   12234.0  58.865735   
5       6      All  12661.0      5914  361971.0   10697.0  61.205783   
6       7      All  11552.0      5394  344299.0    9294.0  63.829996   
7       8      All  10152.0      4737  312510.0    7783.0  65.972134   
8       9      All   8752.0      4061  274715.0    6372.0  67.647131   
9      10      All   7335.0      3374  232392.0    5052.0  68.877297   

     avg_all  trx_freq  trx_util  
0  20.774985  2.128908  0.393291  
1  23.869012  2.136990  0.427553  
2  26.703384  2.142155  0.462817  
3  28.915881  2.142163  0.492748  
4  30.640592  2.140232  0.520517  
5  33.838553  2.140852  0.552865  
6  37.045298  2.141639  0.580374  
7  40.152897  2.143129  0.608634  
8  43.112837  2.155134  0.637320  
9  46.000000  2.173977  0.667854  </code></pre>
</div>
</div>
</section>
<section id="partial-exposures-are-removed-as-a-default" class="level3">
<h3 class="anchored" data-anchor-id="partial-exposures-are-removed-as-a-default">Partial exposures are removed as a default</h3>
<p>As a default, <code>trx_stats()</code> removes partial exposures before summarizing results. This is done to avoid complexity associated with a lopsided skew in the timing of transactions. For example, if transactions can occur on a monthly basis or annually at the beginning of each policy year, partial exposures may not be appropriate. If a policy had an exposure of 0.5 years and was taking withdrawals annually at the beginning of the year, an argument could be made that the exposure should instead be 1 complete year. If the same policy was expected to take withdrawals 9 months into the year, it’s not clear if the exposure should be 0.5 years or 0.5 / 0.75 years. To override this treatment, set the <code>full_exposures_only</code> argument to <code>False</code>.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>exposed_data.trx_stats(full_exposures_only<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="partial-expo-ok" class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Transaction study results

Groups: pol_yr
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider


A DataFrame: 30 x 10
   pol_yr trx_type   trx_n  trx_flag   trx_amt      exposure    avg_trx  \
0       1     Base  8123.0      3818  129155.0  19252.212366  33.827920   
1       1    Rider  8819.0      4103  290608.0  19252.212366  70.828175   
2       2     Base  7924.0      3737  128258.0  17714.780418  34.321113   
3       2    Rider  8976.0      4186  312661.0  17714.780418  74.692069   
4       3     Base  7668.0      3603  127202.0  16097.137376  35.304468   
5       3    Rider  9011.0      4193  322147.0  16097.137376  76.829716   
6       4     Base  7299.0      3427  127108.0  14535.864406  37.090166   
7       4    Rider  8894.0      4148  313402.0  14535.864406  75.554966   
8       5     Base  6777.0      3166  121709.0  12915.526244  38.442514   
9       5    Rider  8576.0      3987  298753.0  12915.526244  74.931778   

     avg_all  trx_freq  trx_util  
0   6.708580  2.127554  0.198315  
1  15.094785  2.149403  0.213118  
2   7.240169  2.120417  0.210954  
3  17.649725  2.144290  0.236300  
4   7.902150  2.128226  0.223829  
5  20.012689  2.149058  0.260481  
6   8.744440  2.129851  0.235762  
7  21.560603  2.144166  0.285363  
8   9.423464  2.140556  0.245131  
9  23.131307  2.150991  0.308698  </code></pre>
</div>
</div>
</section>
<section id="summary-method" class="level3">
<h3 class="anchored" data-anchor-id="summary-method">Summary method</h3>
<p>As noted above, the result of <code>trx_stats()</code> is a <code>TrxStats</code> object. If the <code>summary()</code> function is applied to a <code>TrxStats</code> object, the data will be summarized again and return a higher level <code>TrxStats</code> object.</p>
<p>If no additional arguments are passed, <code>summary()</code> returns a single row of aggregate results for each transaction type.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>trx_res.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="summary1" class="cell-output cell-output-display" data-execution_count="17">
<pre><code>Transaction study results

Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider
Transactions as % of: av_anniv


A DataFrame: 2 x 13
  trx_type    trx_n  trx_flag    trx_amt  exposure    avg_trx    avg_all  \
0     Base  60500.0     28224  1093899.0  124173.0  38.757759   8.809475   
1    Rider  77321.0     35941  2842729.0  124173.0  79.094321  22.893294   

   trx_freq  trx_util     av_anniv  av_anniv_w_trx  pct_of_av_anniv_all  \
0  2.143566  0.227296  184065396.0      43514812.0             0.005943   
1  2.151331  0.289443  184065396.0      47684258.0             0.015444   

   pct_of_av_anniv_w_trx  
0               0.025139  
1               0.059616  </code></pre>
</div>
</div>
<p>If additional variable names are passed to the <code>summary()</code> function, then the output will group the data by those variables. In our example, if <code>pol_yr</code> is passed to <code>summary()</code>, the output will contain one row per policy year for each transaction type.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>trx_res.summary(<span class="st">'pol_yr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="summary2" class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Transaction study results

Groups: pol_yr
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider
Transactions as % of: av_anniv


A DataFrame: 30 x 14
   pol_yr trx_type   trx_n  trx_flag   trx_amt  exposure    avg_trx  \
0       1     Base  7447.0      3514  119877.0   18541.0  34.114115   
1       1    Rider  8077.0      3778  265312.0   18541.0  70.225516   
2       2     Base  7274.0      3422  116967.0   16971.0  34.180888   
3       2    Rider  8232.0      3834  288114.0   16971.0  75.147105   
4       3     Base  7061.0      3309  116357.0   15397.0  35.163796   
5       3    Rider  8204.0      3817  294795.0   15397.0  77.232119   
6       4     Base  6596.0      3080  114987.0   13790.0  37.333442   
7       4    Rider  7960.0      3715  283763.0   13790.0  76.383042   
8       5     Base  6093.0      2847  109918.0   12234.0  38.608360   
9       5    Rider  7536.0      3521  264939.0   12234.0  75.245385   

     avg_all  trx_freq  trx_util    av_anniv  av_anniv_w_trx  \
0   6.465509  2.119237  0.189526  24365915.0       4740352.0   
1  14.309476  2.137904  0.203765  24365915.0       4982082.0   
2   6.892169  2.125658  0.201638  23013944.0       4707718.0   
3  16.976843  2.147105  0.225915  23013944.0       5022297.0   
4   7.557122  2.133877  0.214912  21474409.0       4637509.0   
5  19.146262  2.149332  0.247905  21474409.0       5021453.0   
6   8.338434  2.141558  0.223350  19831268.0       4468860.0   
7  20.577447  2.142665  0.269398  19831268.0       4839690.0   
8   8.984633  2.140148  0.232712  18168403.0       4293638.0   
9  21.655959  2.140301  0.287804  18168403.0       4610865.0   

   pct_of_av_anniv_all  pct_of_av_anniv_w_trx  
0             0.004920               0.025289  
1             0.010889               0.053253  
2             0.005082               0.024846  
3             0.012519               0.057367  
4             0.005418               0.025090  
5             0.013728               0.058707  
6             0.005798               0.025731  
7             0.014309               0.058632  
8             0.006050               0.025600  
9             0.014582               0.057460  </code></pre>
</div>
</div>
<p>Similarly, if <code>inc_guar</code> is passed to <code>summary()</code>, the output will contain a row for each transaction type and unique value in <code>inc_guar</code>.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>trx_res.summary(<span class="st">'inc_guar'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="summary3" class="cell-output cell-output-display" data-execution_count="19">
<pre><code>Transaction study results

Groups: inc_guar
Study range: 1900-01-01 to 2019-12-31
Transaction types: Base, Rider
Transactions as % of: av_anniv


A DataFrame: 4 x 14
   inc_guar trx_type    trx_n  trx_flag    trx_amt  exposure    avg_trx  \
0     False     Base  52939.0     24703   952629.0   48938.0  38.563292   
1     False    Rider      0.0         0        0.0   48938.0        NaN   
2      True     Base   7561.0      3521   141270.0   75235.0  40.122124   
3      True    Rider  77321.0     35941  2842729.0   75235.0  79.094321   

     avg_all  trx_freq  trx_util     av_anniv  av_anniv_w_trx  \
0  19.466039  2.143019  0.504782   74673495.0      37938943.0   
1   0.000000       NaN  0.000000   74673495.0             0.0   
2   1.877716  2.147401  0.046800  109391901.0       5575869.0   
3  37.784661  2.151331  0.477716  109391901.0      47684258.0   

   pct_of_av_anniv_all  pct_of_av_anniv_w_trx  
0             0.012757               0.025110  
1             0.000000                    NaN  
2             0.001291               0.025336  
3             0.025987               0.059616  </code></pre>
</div>
</div>
</section>
<section id="column-names" class="level3">
<h3 class="anchored" data-anchor-id="column-names">Column names</h3>
<p>As a default, <code>add_transactions()</code> assumes the transaction data frame (<code>trx_data</code>) uses the following naming conventions:</p>
<ul>
<li>The policy number column is called <code>pol_num</code></li>
<li>The transaction date column is called <code>trx_date</code></li>
<li>The transaction type column is called <code>trx_type</code></li>
<li>The transaction amount column is called <code>trx_amt</code></li>
</ul>
<p>These default names can be overridden using the <code>col_pol_num</code>, <code>col_trx_date</code>, <code>col_trx_type</code>, and <code>col_trx_amt</code> arguments.</p>
<p>For example, if the transaction type column was called <code>transaction_code</code> in our data, we could write:</p>
<div id="col-names-1" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>exposed_data.add_transactions(withdrawals, col_trx_type<span class="op">=</span><span class="st">"transaction_code"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, <code>trx_stats()</code> assumes the input data uses the name <code>exposure</code> for exposures. This default can be overridden using the argument <code>col_exposure</code>.</p>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<p>The <code>trx_stats()</code> function does not produce any calculations related to the persistence of transactions from exposure period to exposure period.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>See <a href="../articles/exposures.html">Exposures</a> for more information on creating <code>ExposedDF</code> objects.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>